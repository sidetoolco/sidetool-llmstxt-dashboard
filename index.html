<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sidetool LLMs.txt Generator Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-50">
    <div x-data="llmsGenerator()" class="min-h-screen p-8">
        <!-- Header -->
        <div class="max-w-6xl mx-auto mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Sidetool LLMs.txt Generator</h1>
            <p class="text-gray-600">Generate and manage LLMs.txt files for sidetool.co</p>
        </div>

        <!-- Main Content -->
        <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Generation Control -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Generate Files</h2>
                
                <!-- Service Role Key Input -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Service Role Key
                    </label>
                    <input 
                        type="password" 
                        x-model="serviceRoleKey"
                        placeholder="Enter your Supabase service role key"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    <p class="text-xs text-gray-500 mt-1">Your key is stored locally and never sent anywhere except to your Supabase function</p>
                </div>

                <!-- Generate Button -->
                <button 
                    @click="generateFiles()"
                    :disabled="loading || !serviceRoleKey"
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                >
                    <span x-show="!loading">Generate LLMs.txt Files</span>
                    <span x-show="loading" class="flex items-center justify-center">
                        <svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Generating... This may take 30-60 seconds
                    </span>
                </button>

                <!-- Status Messages -->
                <div x-show="statusMessage" class="mt-4">
                    <div 
                        :class="{
                            'bg-green-100 text-green-800': status === 'success',
                            'bg-red-100 text-red-800': status === 'error',
                            'bg-blue-100 text-blue-800': status === 'info'
                        }"
                        class="p-3 rounded-md text-sm"
                    >
                        <span x-text="statusMessage"></span>
                    </div>
                </div>

                <!-- Generation Result -->
                <div x-show="lastResult" class="mt-4 p-4 bg-gray-50 rounded-md">
                    <h3 class="font-semibold text-sm text-gray-700 mb-2">Last Generation Result:</h3>
                    <div class="text-sm space-y-1">
                        <p><span class="font-medium">URLs Processed:</span> <span x-text="lastResult?.urls_processed || 0"></span></p>
                        <p><span class="font-medium">Successful:</span> <span x-text="lastResult?.urls_successful || 0"></span></p>
                        <p><span class="font-medium">From Cache:</span> <span x-text="lastResult?.cached_content || 0"></span></p>
                    </div>
                </div>
            </div>

            <!-- Files Viewer -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Generated Files</h2>
                
                <!-- Date Selector -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Select Date
                    </label>
                    <input 
                        type="date" 
                        x-model="selectedDate"
                        :max="today"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>

                <!-- File Links -->
                <div class="space-y-3">
                    <a 
                        :href="getLlmsUrl()"
                        target="_blank"
                        class="block w-full bg-gray-100 hover:bg-gray-200 px-4 py-3 rounded-md transition-colors"
                    >
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium text-gray-900">llms.txt</p>
                                <p class="text-sm text-gray-500">Index file with summaries</p>
                            </div>
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                            </svg>
                        </div>
                    </a>

                    <a 
                        :href="getLlmsFullUrl()"
                        target="_blank"
                        class="block w-full bg-gray-100 hover:bg-gray-200 px-4 py-3 rounded-md transition-colors"
                    >
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium text-gray-900">llms-full.txt</p>
                                <p class="text-sm text-gray-500">Complete content file</p>
                            </div>
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                            </svg>
                        </div>
                    </a>
                </div>

                <!-- Preview Section -->
                <div class="mt-6">
                    <button 
                        @click="loadPreview()"
                        class="w-full bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition-colors"
                    >
                        Load Preview
                    </button>
                    
                    <div x-show="preview" class="mt-4">
                        <h3 class="font-semibold text-sm text-gray-700 mb-2">Preview (llms.txt):</h3>
                        <pre class="bg-gray-50 p-3 rounded-md text-xs overflow-x-auto max-h-64 overflow-y-auto" x-text="preview"></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Generation History -->
        <div class="max-w-6xl mx-auto mt-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Generation History</h2>
                <button 
                    @click="loadHistory()"
                    class="mb-4 bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition-colors"
                >
                    Load History
                </button>
                
                <div x-show="history.length > 0" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">URLs Processed</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Successful</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="item in history" :key="item.id">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatDate(item.generated_at)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="item.urls_processed"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="item.urls_successful"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span 
                                            x-text="item.error_message ? 'Error' : 'Success'"
                                            :class="item.error_message ? 'text-red-600' : 'text-green-600'"
                                            class="text-sm font-medium"
                                        ></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        function llmsGenerator() {
            return {
                serviceRoleKey: localStorage.getItem('serviceRoleKey') || '',
                loading: false,
                status: '',
                statusMessage: '',
                lastResult: null,
                selectedDate: new Date().toISOString().split('T')[0],
                today: new Date().toISOString().split('T')[0],
                preview: '',
                history: [],
                
                init() {
                    // Save service role key to localStorage when it changes
                    this.$watch('serviceRoleKey', value => {
                        localStorage.setItem('serviceRoleKey', value);
                    });
                },
                
                async generateFiles() {
                    this.loading = true;
                    this.status = 'info';
                    this.statusMessage = 'Generating files... This may take 30-60 seconds';
                    
                    try {
                        const response = await fetch('https://gytlhmhrthpackunppjd.supabase.co/functions/v1/generate-llmstxt', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${this.serviceRoleKey}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            this.status = 'success';
                            this.statusMessage = 'Files generated successfully!';
                            this.lastResult = data;
                            this.selectedDate = this.today;
                        } else {
                            this.status = 'error';
                            this.statusMessage = `Error: ${data.error || 'Unknown error occurred'}`;
                        }
                    } catch (error) {
                        this.status = 'error';
                        this.statusMessage = `Error: ${error.message}`;
                    } finally {
                        this.loading = false;
                    }
                },
                
                getLlmsUrl() {
                    return `https://gytlhmhrthpackunppjd.supabase.co/storage/v1/object/public/llms-files/sidetool/${this.selectedDate}/llms.txt`;
                },
                
                getLlmsFullUrl() {
                    return `https://gytlhmhrthpackunppjd.supabase.co/storage/v1/object/public/llms-files/sidetool/${this.selectedDate}/llms-full.txt`;
                },
                
                async loadPreview() {
                    try {
                        const response = await fetch(this.getLlmsUrl());
                        if (response.ok) {
                            this.preview = await response.text();
                        } else {
                            this.preview = 'No file found for this date';
                        }
                    } catch (error) {
                        this.preview = `Error loading preview: ${error.message}`;
                    }
                },
                
                async loadHistory() {
                    try {
                        const response = await fetch('https://gytlhmhrthpackunppjd.supabase.co/rest/v1/llms_generation_logs?order=generated_at.desc&limit=10', {
                            headers: {
                                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5dGxobWhydGhwYWNrdW5wcGpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxOTA5MjMsImV4cCI6MjA2OTc2NjkyM30.dLUPERm-5vfPaf5_Sfc4WbcELffq4DPesGl1lxZW2bk',
                                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5dGxobWhydGhwYWNrdW5wcGpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxOTA5MjMsImV4cCI6MjA2OTc2NjkyM30.dLUPERm-5vfPaf5_Sfc4WbcELffq4DPesGl1lxZW2bk'
                            }
                        });
                        
                        if (response.ok) {
                            this.history = await response.json();
                        }
                    } catch (error) {
                        console.error('Error loading history:', error);
                    }
                },
                
                formatDate(dateString) {
                    return new Date(dateString).toLocaleString();
                }
            }
        }
    </script>
</body>
</html>